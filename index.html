<!DOCTYPE html>
<html>
<head>
<title>‚ö°Ô∏è PAYEDE ASSOC. v22.0 - CORRIGIDO</title>
<meta name="viewport" content="width=device-width">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* CSS permanece igual - perfeito */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:system-ui;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px;color:white;}
.login-screen{max-width:400px;margin:0 auto;background:white;color:#333;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
.logo h1{font-size:28px;background:linear-gradient(135deg,#4caf50,#28a745);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
.input-group{margin:20px 0;}
input{width:100%;padding:18px;border:2px solid #e1e5e9;border-radius:12px;font-size:16px;}
.btn{width:100%;padding:18px;border:none;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;margin:10px 0;}
.btn-primary{background:linear-gradient(135deg,#4caf50,#45a049);color:white;}
.btn-success{background:linear-gradient(135deg,#28a745,#20c997);color:white;}
.btn-secondary{background:#6c757d;color:white;}
.card{background:white;border-radius:20px;padding:30px;margin:20px 0;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
.balance-display{font-size:32px;font-weight:bold;color:#4caf50;text-align:center;margin:20px 0;}
.hidden{display:none;}
.status{padding:15px;border-radius:8px;margin:10px 0;text-align:center;}
.status.success{background:#d4edda;color:#155724;}
#statusDebug{color:#666;font-size:12px;margin:10px 0;}
</style>
</head>
<body>
<!-- HTML igual -->
<div class="login-screen" id="telaLogin">
  <div class="logo">
    <h1>‚ö°Ô∏è PAYEDE ASSOC. v22.0 ‚úÖ</h1>
    <div style="font-size:14px;opacity:0.8;">üîß Supabase Production - FIXED</div>
  </div>
  <div class="input-group"><input id="nomeLogin" placeholder="üë§ Nome completo"></div>
  <div class="input-group"><input id="chaveLogin" placeholder="üîë Chave da carteira" readonly onclick="this.removeAttribute('readonly');this.focus()"></div>
  <button class="btn btn-primary" onclick="acessarCarteira()">üöÄ ACESSAR</button>
  <button class="btn btn-secondary" onclick="novaCarteira()" style="font-size:14px;padding:12px;">‚ûï CRIAR</button>
  <div id="statusDebug"></div>
</div>

<div id="dashboard" class="hidden">
  <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:15px;text-align:center;margin-bottom:20px;">
    <h2>Bem-vindo(a), <span id="nomeUsuarioDash" style="color:#4caf50;"></span>!</h2>
    <button class="btn btn-secondary" onclick="sair()" style="width:auto;padding:10px 20px;">üîê Sair</button>
  </div>
  
  <div class="card">
    <h3>üí≥ Carteira Ativa</h3>
    <div class="balance-display" id="meuSaldo">0,00 EDE</div>
    <div style="background:#f0f8f0;padding:15px;border-radius:10px;margin:15px 0;">
      üÜî <span id="minhaWalletId"></span><br>
      üîê <input id="minhaChaveInput" readonly style="font-size:14px;">
    </div>
    <button class="btn btn-success" onclick="copiarMinhaChave()">üìã Copiar Chave</button>
  </div>
  
  <div class="card" id="secaoAtivar" style="display:none;">
    <h3>üí∞ Ativar (+10 EDE)</h3>
    <canvas id="qrPicPay" style="display:block;margin:15px auto;width:200px;height:200px;"></canvas>
    <div style="text-align:center;font-size:18px;font-weight:bold;margin:15px 0;">R$ 2,00 PicPay</div>
    <input id="txidPicPay" placeholder="üìã ID transa√ß√£o">
    <button class="btn btn-primary" onclick="ativar()">üöÄ CONFIRMAR</button>
  </div>
  
  <div class="card">
    <h3>üîÄ Transferir</h3>
    <input id="chaveDestino" placeholder="üîë Chave destino">
    <input id="valorTransferir" type="number" step="0.01" placeholder="üí∞ Valor EDE">
    <button class="btn btn-primary" onclick="transferir()">üöÄ Transferir</button>
    <div id="statusTransferencia"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// ‚úÖ CONFIG SUPABASE CORRIGIDA
const SUPABASE_URL = 'https://acvzxoysjglaylrsrnmh.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_wojRa33oQnvD7Q-8MEImLw_ENjObvs4';

// ‚úÖ INICIALIZA√á√ÉO CORRETA v2
const { createClient } = supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let usuarioAtual = null, minhaCarteiraAtiva = null;

document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ DOM carregado - Iniciando app...');
  debug('App iniciado com sucesso!');
  gerarQR();
});

// ‚úÖ DEBUG FUNCTION
function debug(msg) {
  document.getElementById('statusDebug').innerHTML = `<div style="color:#4caf50;">${msg}</div>`;
}

// ‚úÖ CRIAR CARTEIRA - CORRIGIDA
async function novaCarteira() {
  const nome = document.getElementById('nomeLogin').value.trim();
  if(!nome) return alert('‚ùå Nome inv√°lido!');
  
  debug('Criando carteira...');
  
  const walletData = {
    id: `PAY${Date.now().toString(36).slice(-8)}${Math.random().toString(36).slice(-4)}`,
    nome,
    private_key: `PAYEDE_${crypto.randomUUID().replace(/-/g,'')}`,
    balance: 0,
    status: 'criada',
    created_at: new Date().toISOString()
  };
  
  try {
    const { data, error } = await supabase
      .from('wallets')
      .insert([walletData])
      .select()
      .single();
      
    if(error) {
      console.error('Erro:', error);
      return alert(`‚ùå Erro criar carteira: ${error.message}

üí° SQL necess√°rio no Supabase:
CREATE TABLE wallets (
  id text PRIMARY KEY, 
  nome text, 
  private_key text UNIQUE, 
  balance numeric DEFAULT 0, 
  status text DEFAULT 'criada',
  created_at timestamptz DEFAULT now()
);

ALTER TABLE wallets ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read" ON wallets FOR SELECT USING (true);
CREATE POLICY "Allow public insert" ON wallets FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow public update" ON wallets FOR UPDATE USING (true);`);
    }
    
    minhaCarteiraAtiva = data;
    usuarioAtual = nome;
    mostrarDashboard();
    copiarMinhaChave();
    debug(`‚úÖ Carteira ${data.id} criada!`);
    alert(`‚úÖ Carteira criada!
üÜî ${data.id}
üë§ ${nome}`);
  } catch(e) {
    console.error('Erro geral:', e);
    alert('‚ùå Erro: ' + e.message);
  }
}

// ‚úÖ ACESSAR CARTEIRA - CORRIGIDA
async function acessarCarteira() {
  const nome = document.getElementById('nomeLogin').value.trim();
  const chave = document.getElementById('chaveLogin').value.trim();
  
  if(!nome && !chave) return alert('‚ùå Informe nome OU chave!');
  
  debug('Buscando carteira...');
  
  try {
    let query = supabase.from('wallets').select('*');
    if(chave) query = query.eq('private_key', chave);
    else if(nome) query = query.eq('nome', nome).limit(1);
    
    const { data, error } = await query;
    if(error) {
      console.error('Erro query:', error);
      return alert('‚ùå Erro busca: ' + error.message);
    }
    
    if(!data?.[0]) return alert('‚ùå Carteira n√£o encontrada!');
    
    minhaCarteiraAtiva = data[0];
    usuarioAtual = minhaCarteiraAtiva.nome;
    mostrarDashboard();
    debug(`‚úÖ Carteira ${minhaCarteiraAtiva.id} carregada`);
  } catch(e) {
    console.error('Erro acessar:', e);
    alert('‚ùå Erro: ' + e.message);
  }
}

// ‚úÖ ATIVAR - CORRIGIDA (sem RPC)
async function ativar() {
  const txid = document.getElementById('txidPicPay').value.trim();
  if(!txid || txid.length < 10) return alert('‚ùå TXID inv√°lido (10+ chars)!');
  
  try {
    const novoSaldo = 10;
    const { data, error } = await supabase
      .from('wallets')
      .update({ balance: novoSaldo, status: 'ativa' })
      .eq('id', minhaCarteiraAtiva.id)
      .select()
      .single();
      
    if(error) throw error;
      
    minhaCarteiraAtiva = data;
    document.getElementById('meuSaldo').textContent = '10.00 EDE';
    document.getElementById('secaoAtivar').style.display = 'none';
    document.getElementById('statusTransferencia').innerHTML = '<div class="status success">‚úÖ +10 EDE ativados!</div>';
    debug('‚úÖ Ativa√ß√£o conclu√≠da');
    alert('‚úÖ +10 EDE ativados!');
  } catch(e) {
    alert('‚ùå Erro ativa√ß√£o: ' + e.message);
  }
}

// ‚úÖ TRANSFERIR - CORRIGIDA (sem RPC)
async function transferir() {
  const chaveDest = document.getElementById('chaveDestino').value.trim();
  const valor = parseFloat(document.getElementById('valorTransferir').value);
  
  if(valor <= 0 || !Number.isFinite(valor)) return alert('‚ùå Valor inv√°lido!');
  if(valor > minhaCarteiraAtiva.balance) return alert('‚ùå Saldo insuficiente!');
  
  try {
    // Busca destino
    const { data: destino } = await supabase
      .from('wallets')
      .select('id, balance')
      .eq('private_key', chaveDest)
      .single();
      
    if(!destino) return alert('‚ùå Chave destino inv√°lida!');
    
    // Atualiza origem
    await supabase
      .from('wallets')
      .update({ balance: minhaCarteiraAtiva.balance - valor })
      .eq('id', minhaCarteiraAtiva.id);
      
    // Atualiza destino
    await supabase
      .from('wallets')
      .update({ balance: destino.balance + valor })
      .eq('id', destino.id);
    
    document.getElementById('statusTransferencia').innerHTML = '<div class="status success">‚úÖ Transferido!</div>';
    document.getElementById('chaveDestino').value = document.getElementById('valorTransferir').value = '';
    debug(`‚úÖ ${valor.toFixed(2)} EDE transferido`);
    alert(`‚úÖ ${valor.toFixed(2)} EDE transferido!`);
  } catch(e) {
    alert('‚ùå Erro transfer√™ncia: ' + e.message);
  }
}

function mostrarDashboard() {
  document.getElementById('telaLogin').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('nomeUsuarioDash').textContent = usuarioAtual;
  document.getElementById('meuSaldo').textContent = parseFloat(minhaCarteiraAtiva.balance || 0).toFixed(2) + ' EDE';
  document.getElementById('minhaWalletId').textContent = minhaCarteiraAtiva.id;
  document.getElementById('minhaChaveInput').value = minhaCarteiraAtiva.private_key;
  if(parseFloat(minhaCarteiraAtiva.balance || 0) === 0) {
    document.getElementById('secaoAtivar').style.display = 'block';
  }
}

async function conectarRealtime() {
  const channel = supabase.channel('wallets')
    .on('postgres_changes', 
      { event: 'UPDATE', schema: 'public', table: 'wallets' }, 
      (payload) => {
        console.log('Realtime:', payload);
        if(payload.new.id === minhaCarteiraAtiva?.id) {
          minhaCarteiraAtiva.balance = payload.new.balance;
          document.getElementById('meuSaldo').textContent = payload.new.balance.toFixed(2) + ' EDE';
        }
      }
    )
    .subscribe();
}

function copiarMinhaChave() {
  navigator.clipboard.writeText(document.getElementById('minhaChaveInput').value).then(() => {
    debug('‚úÖ Chave copiada!');
  });
}

function sair() {
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('telaLogin').classList.remove('hidden');
  document.getElementById('nomeLogin').value = document.getElementById('chaveLogin').value = '';
  usuarioAtual = null;
  minhaCarteiraAtiva = null;
  debug('');
}

function gerarQR() {
  try {
    QRCode.toCanvas(document.getElementById('qrPicPay'), 'picpay://pay?username=jaedesystemint&amount=2.00');
  } catch(e) {
    document.getElementById('qrPicPay').innerHTML = 'QR PicPay: R$2,00 @jaedesystemint';
  }
}
</script>
</body>
</html>