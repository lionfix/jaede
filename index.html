<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>‚ö°Ô∏è PAYEDE ASSOC. v23.0 - Fintech (Moeda Digital)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:system-ui;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px;color:white;}
    .wrap{max-width:420px;margin:0 auto;}
    .card{background:white;color:#333;border-radius:20px;padding:28px;margin:14px 0;box-shadow:0 20px 60px rgba(0,0,0,0.25);}
    .logo h1{font-size:26px;background:linear-gradient(135deg,#4caf50,#28a745);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
    .muted{opacity:.75;font-size:13px;margin-top:6px}
    .input-group{margin:14px 0;}
    input{width:100%;padding:16px;border:2px solid #e1e5e9;border-radius:12px;font-size:15px;outline:none;}
    input:focus{border-color:#4caf50}
    .btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin:8px 0;}
    .btn-primary{background:linear-gradient(135deg,#4caf50,#45a049);color:white;}
    .btn-secondary{background:#6c757d;color:white;}
    .btn-danger{background:#dc3545;color:white;}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .hidden{display:none;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;background:#eef6ee;color:#1f7a37;font-weight:700}
    .balance{font-size:34px;font-weight:900;color:#1f7a37;text-align:center;margin:14px 0;}
    .box{background:#f4f7fb;border-radius:14px;padding:12px;margin-top:10px;font-size:13px}
    .status{padding:12px;border-radius:12px;margin-top:10px;font-size:13px;line-height:1.35}
    .status.info{background:#e7f3ff;color:#0b3d91;}
    .status.ok{background:#d4edda;color:#155724;}
    .status.err{background:#f8d7da;color:#721c24;}
    .small{font-size:12px;opacity:.85}
    a{color:#1f7a37;text-decoration:none}
    code{background:#f1f3f5;padding:2px 6px;border-radius:6px}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="card">
      <div class="logo">
        <h1>‚ö°Ô∏è PAYEDE ASSOC. v23.0</h1>
        <div class="muted">Fintech-style (seguro) ‚Ä¢ Moeda digital <b>EDE</b> ‚Ä¢ Supabase Auth + Ledger</div>
      </div>
      <div id="globalStatus" class="status info" style="display:none;"></div>
    </div>

    <!-- AUTH -->
    <div id="screenAuth" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3>üîê Entrar</h3>
        <span class="pill">AUTH</span>
      </div>

      <div class="input-group">
        <input id="authEmail" type="email" placeholder="üìß Email" autocomplete="email">
      </div>
      <div class="input-group">
        <input id="authPass" type="password" placeholder="üîë Senha (6+)" autocomplete="current-password">
      </div>

      <button class="btn btn-primary" onclick="signIn()">üöÄ Entrar</button>

      <div class="row">
        <button class="btn btn-secondary" onclick="signUp()">‚ûï Criar conta</button>
        <button class="btn btn-secondary" onclick="resetPass()">üì© Esqueci</button>
      </div>

      <div class="small" style="margin-top:6px;">
        ‚ö†Ô∏è Seguran√ßa real: sem saldo edit√°vel no front. Transfer√™ncias via <code>RPC</code>.
      </div>
    </div>

    <!-- ONBOARD (criar carteira) -->
    <div id="screenOnboard" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3>üë§ Criar sua carteira</h3>
        <span class="pill">ONBOARD</span>
      </div>

      <div class="input-group">
        <input id="fullName" placeholder="üë§ Nome completo">
      </div>
      <button class="btn btn-primary" onclick="createAccount()">üí≥ Criar carteira</button>

      <div class="small">
        Sua carteira gera uma chave p√∫blica (para receber EDE). Chave privada n√£o √© usada aqui ‚Äî sua conta √© protegida pelo login.
      </div>
    </div>

    <!-- DASH -->
    <div id="screenDash" class="hidden">

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div class="pill">DASH</div>
            <div class="small" style="margin-top:8px;">Logado como: <span id="whoami"></span></div>
          </div>
          <button class="btn btn-danger" style="width:auto;padding:10px 14px;margin:0" onclick="logout()">Sair</button>
        </div>

        <div class="balance" id="balanceEde">0.00 EDE</div>

        <div class="box">
          <div><b>üí≥ Carteira:</b> <span id="publicKey"></span></div>
          <div style="margin-top:8px" class="row">
            <button class="btn btn-secondary" onclick="copyPublicKey()" style="margin:0;">üìã Copiar chave</button>
            <button class="btn btn-secondary" onclick="refreshAll()" style="margin:0;">üîÑ Atualizar</button>
          </div>
        </div>

        <div id="dashStatus" class="status info" style="display:none;"></div>
      </div>

      <!-- TRANSFER -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>üîÄ Transferir EDE</h3>
          <span class="pill">RPC</span>
        </div>

        <div class="input-group">
          <input id="toPublicKey" placeholder="üîë Chave p√∫blica destino (PAYEDE_...)">
        </div>

        <div class="input-group">
          <input id="amountEde" type="number" step="0.01" placeholder="üí∞ Valor em EDE (ex: 1.50)">
        </div>

        <button class="btn btn-primary" onclick="send()">üöÄ Enviar</button>

        <div id="txStatus" class="status info" style="display:none;"></div>

        <div class="small">
          Dica: EDE usa centavos internamente (integer) para evitar bugs de decimal.
        </div>
      </div>

      <!-- (OPCIONAL) "Dep√≥sito" DEMO: s√≥ para testes -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>üß™ Cr√©dito de teste</h3>
          <span class="pill">DEV</span>
        </div>
        <div class="small">
          Isso √© apenas para testes (moeda digital). Em produ√ß√£o, dep√≥sito real exigiria integra√ß√£o e valida√ß√£o do provedor.
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn btn-secondary" onclick="devCredit(100)" style="margin:0;">+1.00 EDE</button>
          <button class="btn btn-secondary" onclick="devCredit(1000)" style="margin:0;">+10.00 EDE</button>
        </div>
        <div id="devStatus" class="status info" style="display:none;"></div>
      </div>

    </div>
  </div>

  <script>
    // =========================
    // ‚úÖ CONFIGURE AQUI
    // =========================
    const SUPABASE_URL = 'https://acvzxoysjglaylrsrnmh.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_wojRa33oQnvD7Q-8MEImLw_ENjObvs4';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // IDs locais
    let sessionUser = null;
    let myAccountId = null;
    let myPublicKey = null;

    // Mostrar erros JS na tela (Android-friendly)
    window.onerror = function (msg, url, line, col, err) {
      showGlobal(`‚ùå ERRO JS: ${String(msg)} (linha ${line}:${col})`, 'err');
      console.error('JS ERROR:', msg, url, line, col, err);
      return true;
    };

    function show(elId, msg, kind='info') {
      const el = document.getElementById(elId);
      if (!el) return;
      el.style.display = 'block';
      el.className = 'status ' + (kind === 'ok' ? 'ok' : kind === 'err' ? 'err' : 'info');
      el.innerHTML = msg;
    }

    function hide(elId) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.style.display = 'none';
      el.innerHTML = '';
    }

    function showGlobal(msg, kind='info') {
      show('globalStatus', msg, kind);
      // auto-hide leve
      setTimeout(() => hide('globalStatus'), 9000);
    }

    function centsFromEdeString(v) {
      const n = Number(v);
      if (!Number.isFinite(n) || n <= 0) return null;
      return Math.round(n * 100); // 2 casas
    }

    function formatEdeFromCents(cents) {
      const n = (Number(cents) || 0) / 100;
      return n.toFixed(2) + ' EDE';
    }

    function setScreen(name) {
      document.getElementById('screenAuth').classList.add('hidden');
      document.getElementById('screenOnboard').classList.add('hidden');
      document.getElementById('screenDash').classList.add('hidden');
      document.getElementById(name).classList.remove('hidden');
    }

    async function bootstrap() {
      // Restaura sess√£o
      const { data } = await supa.auth.getSession();
      sessionUser = data?.session?.user ?? null;

      // listener de auth
      supa.auth.onAuthStateChange(async (_event, newSession) => {
        sessionUser = newSession?.user ?? null;
        await route();
      });

      await route();
    }

    async function route() {
      hide('dashStatus'); hide('txStatus'); hide('devStatus');

      if (!sessionUser) {
        setScreen('screenAuth');
        return;
      }

      document.getElementById('whoami').textContent = sessionUser.email;

      // tenta achar conta do user
      const { data, error } = await supa
        .from('accounts')
        .select('id, public_key')
        .limit(1);

      // Se RLS estiver ok, esse select retorna s√≥ do pr√≥prio usu√°rio
      if (error) {
        showGlobal(`‚ö†Ô∏è Erro ao ler carteira: ${error.message}`, 'err');
        // Ainda assim mostra dash com status
        setScreen('screenDash');
        show('dashStatus', `‚ùå N√£o consegui ler sua carteira. Verifique RLS/SQL. <br><b>${error.message}</b>`, 'err');
        return;
      }

      if (!data || data.length === 0) {
        // precisa criar carteira
        setScreen('screenOnboard');
        return;
      }

      myAccountId = data[0].id;
      myPublicKey = data[0].public_key;
      setScreen('screenDash');
      await refreshAll();
    }

    // =========================
    // AUTH
    // =========================
    async function signUp() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPass').value.trim();
      if (!email || password.length < 6) return showGlobal('‚ùå Informe email e senha (6+).', 'err');

      showGlobal('‚è≥ Criando conta...', 'info');

      const { error } = await supa.auth.signUp({ email, password });
      if (error) return showGlobal('‚ùå ' + error.message, 'err');

      showGlobal('‚úÖ Conta criada! Agora fa√ßa login (ou confirme email se exigido).', 'ok');
    }

    async function signIn() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPass').value.trim();
      if (!email || !password) return showGlobal('‚ùå Informe email e senha.', 'err');

      showGlobal('‚è≥ Entrando...', 'info');

      const { data, error } = await supa.auth.signInWithPassword({ email, password });
      if (error) return showGlobal('‚ùå ' + error.message, 'err');

      sessionUser = data.user;
      showGlobal('‚úÖ Login OK!', 'ok');
      await route();
    }

    async function resetPass() {
      const email = document.getElementById('authEmail').value.trim();
      if (!email) return showGlobal('‚ùå Informe seu email.', 'err');

      const { error } = await supa.auth.resetPasswordForEmail(email);
      if (error) return showGlobal('‚ùå ' + error.message, 'err');

      showGlobal('‚úÖ Email de recupera√ß√£o enviado.', 'ok');
    }

    async function logout() {
      await supa.auth.signOut();
      sessionUser = null;
      myAccountId = null;
      myPublicKey = null;
      showGlobal('üîê Voc√™ saiu.', 'info');
      setScreen('screenAuth');
    }

    // =========================
    // CRIAR CARTEIRA (RPC)
    // Precisa da fun√ß√£o SQL: create_account(p_full_name text)
    // =========================
    async function createAccount() {
      const fullName = document.getElementById('fullName').value.trim();
      if (!fullName) return showGlobal('‚ùå Informe seu nome.', 'err');

      showGlobal('‚è≥ Criando carteira...', 'info');

      const { data, error } = await supa.rpc('create_account', { p_full_name: fullName });
      if (error) return showGlobal('‚ùå ' + error.message, 'err');

      // data √© array com {account_id, public_key}
      const row = data?.[0];
      if (!row) return showGlobal('‚ùå RPC n√£o retornou dados.', 'err');

      myAccountId = row.account_id;
      myPublicKey = row.public_key;

      showGlobal('‚úÖ Carteira criada!', 'ok');
      setScreen('screenDash');
      await refreshAll();
    }

    // =========================
    // DASH: saldo (view)
    // Precisa da view: account_balances
    // =========================
    async function refreshAll() {
      if (!myAccountId) return;

      show('dashStatus', '‚è≥ Atualizando saldo...', 'info');

      // pega carteira do user (garante chave atual)
      const { data: acc, error: e1 } = await supa
        .from('accounts')
        .select('id, public_key')
        .eq('id', myAccountId)
        .single();

      if (e1) {
        show('dashStatus', '‚ùå Erro ao ler conta: ' + e1.message, 'err');
        return;
      }

      myPublicKey = acc.public_key;
      document.getElementById('publicKey').textContent = myPublicKey;

      // pega saldo via view
      const { data: bal, error: e2 } = await supa
        .from('account_balances')
        .select('balance_cents')
        .eq('account_id', myAccountId)
        .single();

      if (e2) {
        show('dashStatus', '‚ùå Erro ao ler saldo: ' + e2.message, 'err');
        return;
      }

      document.getElementById('balanceEde').textContent = formatEdeFromCents(bal.balance_cents);
      show('dashStatus', '‚úÖ Saldo atualizado.', 'ok');
      setTimeout(() => hide('dashStatus'), 2500);
    }

    async function copyPublicKey() {
      try {
        await navigator.clipboard.writeText(myPublicKey || '');
        showGlobal('‚úÖ Chave copiada!', 'ok');
      } catch {
        showGlobal('‚ö†Ô∏è N√£o consegui copiar automaticamente. Copie manualmente: ' + (myPublicKey || ''), 'info');
      }
    }

    // =========================
    // TRANSFER (RPC at√¥mica)
    // Precisa da fun√ß√£o SQL: transfer(...)
    // =========================
    async function send() {
      const toKey = document.getElementById('toPublicKey').value.trim();
      const cents = centsFromEdeString(document.getElementById('amountEde').value);

      if (!toKey.startsWith('PAYEDE_')) return show('txStatus', '‚ùå Chave destino inv√°lida.', 'err');
      if (!cents) return show('txStatus', '‚ùå Valor inv√°lido.', 'err');

      const idem = 'tx_' + Date.now() + '_' + Math.random().toString(16).slice(2);

      show('txStatus', '‚è≥ Enviando (RPC)...', 'info');

      const { data, error } = await supa.rpc('transfer', {
        p_from_public_key: myPublicKey,
        p_to_public_key: toKey,
        p_amount_cents: cents,
        p_idempotency_key: idem
      });

      if (error) {
        // erros comuns: insufficient_funds, to_account_not_found, etc
        return show('txStatus', '‚ùå ' + error.message, 'err');
      }

      const row = data?.[0];
      show('txStatus', `‚úÖ Transfer√™ncia conclu√≠da!<br>ID: <code>${row.transfer_id}</code><br>Status: <b>${row.status}</b>`, 'ok');

      document.getElementById('toPublicKey').value = '';
      document.getElementById('amountEde').value = '';

      await refreshAll();
    }

    // =========================
    // DEV CREDIT (opcional)
    // Para funcionar, crie um RPC DEV ou rode SQL manualmente.
    // Aqui vamos fazer via RPC "dev_credit" se voc√™ quiser criar.
    // =========================
    async function devCredit(amountCents) {
      show('devStatus', '‚è≥ Creditando (DEV)...', 'info');

      // Voc√™ pode criar essa fun√ß√£o no SQL se quiser:
      // create function dev_credit(p_public_key text, p_amount_cents bigint) ...
      const { data, error } = await supa.rpc('dev_credit', {
        p_public_key: myPublicKey,
        p_amount_cents: amountCents
      });

      if (error) {
        return show('devStatus', `‚ö†Ô∏è DEV credit n√£o configurado no banco.<br><b>${error.message}</b><br>
        Se quiser, eu te mando o SQL da fun√ß√£o <code>dev_credit</code>.`, 'err');
      }

      show('devStatus', '‚úÖ Cr√©dito aplicado!', 'ok');
      await refreshAll();
    }

    // start
    bootstrap();
  </script>
</body>
</html>